<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–º–æ—Ñ–æ–Ω–∞–º–∏</title>
    <link rel="stylesheet" href="/static/main.css">
    <link rel="icon" href="/static/testnof.png" sizes="32x32">
</head>
<body>
    <header>
        <nav class="nav-bar">
            <a href="/" class="nav-item">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/notifications" class="nav-item">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a>
            <a href="/calls" class="nav-item">–í—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏</a>
        </nav>
    </header>

    <main class="main-content">
        <div class="section-title-wrapper">
            <h1 class="section-title">–î–æ–º–æ—Ñ–æ–Ω—ã</h1>
            <span class="refresh-icon" onclick="refreshDoorphones()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</span>
        </div>

        <div class="doorphone-list">
            {% for mac, cfg in door_phones.items() %}
            <div class="doorphone-item-wrapper">
                <a href="/doorphones/{{ mac }}" class="doorphone-item">
                    {{ mac }} ‚Äî {{ cfg.location }}
                    {% if cfg.active %}(–ê–∫—Ç–∏–≤–µ–Ω){% else %}(–ù–µ–∞–∫—Ç–∏–≤–µ–Ω{% if cfg.error == True %} - –û—à–∏–±–∫–∞{% endif %}){% endif %}
                </a>
                {% if not cfg.active %}
                <button class="delete-button" onclick="openModal('{{ mac }}')">&times;</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        <div class="modal-overlay" id="deleteModal">
            <div class="modal">
                <p>–£–¥–∞–ª–∏—Ç—å –¥–æ–º–æ—Ñ–æ–Ω <span id="modalMac"></span>?</p>
                <form id="deleteForm" method="post" action="/doorphones/{mac}/delete">
                    <button type="submit" class="confirm-button">–î–∞</button>
                    <button type="button" class="cancel-button" onclick="closeModal()">–ù–µ—Ç</button>
                </form>
            </div>
        </div>
    </main>

<script>
    function openModal(mac) {
        document.getElementById('modalMac').textContent = mac;
        document.getElementById('deleteForm').action = `/doorphones/${mac}/delete`;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    async function refreshDoorphones() {
        const container = document.querySelector('.doorphone-list');
        try {
            const res = await fetch('/api/doorphones/data');
            const data = await res.json();

            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–æ–º–æ—Ñ–æ–Ω–æ–≤</p>';
                return;
            }

            container.innerHTML = Object.entries(data).map(([mac, cfg]) => `
                <div class="doorphone-item-wrapper">
                    <a href="/doorphones/${mac}" class="doorphone-item">
                        ${mac} ‚Äî ${cfg.location}
                        ${cfg.active ? '(–ê–∫—Ç–∏–≤–µ–Ω)' : `(–ù–µ–∞–∫—Ç–∏–≤–µ–Ω${cfg.error ? ' - –û—à–∏–±–∫–∞' : ''})`}
                    </a>
                    ${!cfg.active ? `<button class="delete-button" onclick="openModal('${mac}')">&times;</button>` : ''}
                </div>
            `).join('');
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', err);
        }
    }
</script>


</body>
</html>
